name: Validate Plugin
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate marketplace.json syntax
        run: python3 -c "import json; json.load(open('.claude-plugin/marketplace.json'))"

      - name: Validate plugin.json syntax
        run: python3 -c "import json; json.load(open('plugins/claude-language-coach/.claude-plugin/plugin.json'))"

      - name: Validate hooks.json syntax
        run: python3 -c "import json; json.load(open('plugins/claude-language-coach/hooks/hooks.json'))"

      - name: Validate JSON templates
        run: |
          for f in plugins/claude-language-coach/skills/lang/templates/*.json; do
            [ -f "$f" ] || continue
            echo "Validating $f"
            python3 -c "import json; json.load(open('$f'))"
          done

      - name: Check required plugin.json fields
        run: |
          python3 -c "
          import json
          data = json.load(open('plugins/claude-language-coach/.claude-plugin/plugin.json'))
          required = ['name', 'description', 'version', 'license']
          for field in required:
              assert field in data, f'Missing required field: {field}'
          print('All required fields present')
          "

      - name: Check SKILL.md frontmatter
        run: |
          for f in plugins/claude-language-coach/skills/*/SKILL.md; do
            echo "Checking $f"
            head -1 "$f" | grep -q "^---" || (echo "Missing frontmatter in $f" && exit 1)
          done

      - name: Validate version matches CHANGELOG
        run: |
          VERSION=$(python3 -c "import json; print(json.load(open('plugins/claude-language-coach/.claude-plugin/plugin.json'))['version'])")
          grep -q "\[${VERSION}\]" CHANGELOG.md || (echo "Version $VERSION not found in CHANGELOG.md" && exit 1)
          echo "Version $VERSION found in CHANGELOG.md"
